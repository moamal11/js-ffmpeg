<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>أداة تحويل الفيديو</title>
    <!-- أهم جزء: رؤوس الأمان -->
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin">
    <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp">
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .alert { background: #fff3cd; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        #app { display: none; }
    </style>
</head>
<body>
    <div id="compat-alert" class="alert">
        <h3>تنبيه تقني</h3>
        <p id="compat-message">جارٍ التحقق من متطلبات النظام...</p>
    </div>

    <div id="app">
        <h1>محول الفيديو في المتصفح</h1>
        <input type="file" id="file-input" accept="video/*" />
        <button id="convert-btn">تحويل</button>
        <div id="status"></div>
        <video id="output" controls style="display:none; width:100%;"></video>
    </div>

    <!-- استخدام إصدار خاص يعمل بدون SharedArrayBuffer -->
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <script>
    // دالة التحقق من التوافق
    async function checkCompatibility() {
        const compatMsg = document.getElementById('compat-message');
        
        // الحل الجذري: استخدام إصدار core-st البديل
        try {
            if (typeof SharedArrayBuffer === 'undefined') {
                console.log("Using fallback core (without SharedArrayBuffer)");
                await loadFFmpegWithFallback();
            } else {
                await loadStandardFFmpeg();
            }
            document.getElementById('compat-alert').style.display = 'none';
            document.getElementById('app').style.display = 'block';
        } catch (error) {
            compatMsg.innerHTML = `
                <strong>خطأ غير متوقع:</strong> ${error.message}<br><br>
                جرب ما يلي:<br>
                1. استخدام متصفح Chrome/Firefox حديث<br>
                2. تشغيل الأداة على <a href="https://localhost:3000">localhost</a><br>
                3. تحديث الصفحة (F5)
            `;
            console.error("Initialization failed:", error);
        }
    }

    // تحميل FFmpeg مع الحل البديل
    async function loadFFmpegWithFallback() {
        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({
            log: true,
            corePath: 'https://cdn.jsdelivr.net/npm/@ffmpeg/core-st@0.11.1/dist/ffmpeg-core.js'
        });
        
        document.getElementById('status').textContent = 'جارٍ التهيئة...';
        await ffmpeg.load();
        setupConversion(ffmpeg, fetchFile);
    }

    // تحميل FFmpeg القياسي (إذا كان مدعوماً)
    async function loadStandardFFmpeg() {
        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({ log: true });
        
        document.getElementById('status').textContent = 'جارٍ التهيئة...';
        await ffmpeg.load();
        setupConversion(ffmpeg, fetchFile);
    }

    // إعداد واجهة التحويل
    function setupConversion(ffmpeg, fetchFile) {
        document.getElementById('convert-btn').addEventListener('click', async () => {
            const file = document.getElementById('file-input').files[0];
            if (!file) return alert('اختر ملف فيديو أولاً');

            try {
                document.getElementById('convert-btn').disabled = true;
                document.getElementById('status').textContent = 'جارٍ التحويل...';
                
                // كتابة الملف وتحويله
                ffmpeg.FS('writeFile', file.name, await fetchFile(file));
                await ffmpeg.run('-i', file.name, '-c:v', 'libx264', '-crf', '23', 'output.mp4');
                
                // عرض الناتج
                const data = ffmpeg.FS('readFile', 'output.mp4');
                const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
                const video = document.getElementById('output');
                video.src = url;
                video.style.display = 'block';
                document.getElementById('status').textContent = 'تم التحويل بنجاح!';
            } catch (error) {
                document.getElementById('status').textContent = `خطأ: ${error.message}`;
                console.error("Conversion error:", error);
            } finally {
                document.getElementById('convert-btn').disabled = false;
            }
        });
    }

    // بدء التطبيق عند تحميل الصفحة
    window.addEventListener('DOMContentLoaded', checkCompatibility);
    </script>
</body>
</html>
