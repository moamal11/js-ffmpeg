<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>محول الفيديو</title>
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin">
    <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp">
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .alert { background: #ffeeba; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        #app { display: none; }
        #progress { width: 100%; background: #f3f3f3; margin: 10px 0; }
        #progress-bar { height: 20px; background: #4CAF50; width: 0%; }
    </style>
</head>
<body>
    <div id="compat-alert" class="alert">
        <h3>تهيئة النظام...</h3>
        <p id="compat-message">جارٍ التحقق من المتطلبات الأساسية</p>
    </div>

    <div id="app">
        <h1>محول الفيديو في المتصفح</h1>
        <input type="file" id="file-input" accept="video/*" />
        <button id="convert-btn">بدء التحويل</button>
        <div id="progress" style="display:none;">
            <div id="progress-bar"></div>
        </div>
        <div id="status"></div>
        <video id="output" controls style="display:none; width:100%;"></video>
    </div>

    <!-- استخدام إصدارات محددة ومختبرة -->
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.10.1/dist/ffmpeg.min.js"></script>
    <script>
    // إصدارات معتمدة
    const CORE_VERSION = '0.9.2';
    const CORE_URL = `https://cdn.jsdelivr.net/npm/@ffmpeg/core@${CORE_VERSION}/dist/ffmpeg-core.js`;

    async function initializeFFmpeg() {
        try {
            // التحقق من دعم WASM
            if (!WebAssembly) throw new Error("المتصفح لا يدعم WebAssembly");
            
            const { createFFmpeg, fetchFile } = FFmpeg;
            const ffmpeg = createFFmpeg({
                log: true,
                corePath: CORE_URL,
                progress: ({ ratio }) => {
                    const percent = Math.round(ratio * 100);
                    document.getElementById('progress-bar').style.width = `${percent}%`;
                }
            });

            document.getElementById('compat-message').textContent = 'جارٍ تحميل محرك FFmpeg...';
            document.getElementById('progress').style.display = 'block';

            await ffmpeg.load();
            
            document.getElementById('compat-alert').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            document.getElementById('progress').style.display = 'none';
            document.getElementById('status').textContent = 'جاهز للتحويل';

            setupUI(ffmpeg, fetchFile);
        } catch (error) {
            showError(error);
        }
    }

    function setupUI(ffmpeg, fetchFile) {
        document.getElementById('convert-btn').addEventListener('click', async () => {
            const file = document.getElementById('file-input').files[0];
            if (!file) return alert('يجب اختيار ملف فيديو أولاً');

            try {
                document.getElementById('convert-btn').disabled = true;
                document.getElementById('status').textContent = 'جارٍ معالجة الفيديو...';
                document.getElementById('progress').style.display = 'block';

                // 1. كتابة الملف إلى نظام الملفات الظاهري
                ffmpeg.FS('writeFile', file.name, await fetchFile(file));

                // 2. تشغيل أمر التحويل (بإعدادات متوافقة)
                await ffmpeg.run(
                    '-i', file.name,
                    '-c:v', 'libx264',
                    '-preset', 'fast',
                    '-crf', '23',
                    '-movflags', '+faststart',
                    'output.mp4'
                );

                // 3. قراءة الناتج
                const data = ffmpeg.FS('readFile', 'output.mp4');
                const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
                
                // 4. عرض الناتج
                const video = document.getElementById('output');
                video.src = url;
                video.style.display = 'block';
                document.getElementById('status').textContent = 'تم التحويل بنجاح!';
            } catch (error) {
                showError(error);
            } finally {
                document.getElementById('convert-btn').disabled = false;
                document.getElementById('progress').style.display = 'none';
            }
        });
    }

    function showError(error) {
        console.error(error);
        document.getElementById('compat-message').innerHTML = `
            <strong>حدث خطأ:</strong> ${error.message}<br><br>
            <b>الحلول المقترحة:</b>
            <ol>
                <li>تأكد من استخدام Chrome/Firefox حديث</li>
                <li>جرب تشغيل الأداة على <a href="http://localhost:3000">خادم محلي</a></li>
                <li>حدّث الصفحة (F5)</li>
                <li>جرب متصفحاً آخر</li>
            </ol>
            <small>تفاصيل الخطأ: ${error}</small>
        `;
    }

    // بدء التطبيق بعد تحميل الصفحة
    window.addEventListener('DOMContentLoaded', initializeFFmpeg);
    </script>
</body>
</html>
